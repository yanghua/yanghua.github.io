<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6q22x_DFglYGJjD5t1d95nBYd_U8cDU04B-Haky8KHs" />
  <meta name="baidu-site-verification" content="yEdVDDBr1C" />
  
  <title>开发自己的Web服务处理程序(以支持Ajax框架异步调用Web服务方法) | yanghua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="当你添加Asp.net AJAX功能到你的Web程序的时候，你需要在Web.config中做一些改变，需要你显式地移除默认的ASMX处理程序并且添加asp.net ajax框架自己的脚本处理器来作为ASMX处理程序。在上一篇异步调用Web服务方法中，我们谈论过，ajax框架的asmx(ScriptHandler)是不支持异步调用Web服务方法的，所以为了让asp.netajax支持异步Web方法调">
<meta property="og:type" content="article">
<meta property="og:title" content="开发自己的Web服务处理程序(以支持Ajax框架异步调用Web服务方法)">
<meta property="og:url" content="http://vinoyang.com/2011/12/05/开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法/index.html">
<meta property="og:site_name" content="yanghua">
<meta property="og:description" content="当你添加Asp.net AJAX功能到你的Web程序的时候，你需要在Web.config中做一些改变，需要你显式地移除默认的ASMX处理程序并且添加asp.net ajax框架自己的脚本处理器来作为ASMX处理程序。在上一篇异步调用Web服务方法中，我们谈论过，ajax框架的asmx(ScriptHandler)是不支持异步调用Web服务方法的，所以为了让asp.netajax支持异步Web方法调">
<meta property="og:updated_time" content="2015-11-27T05:26:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开发自己的Web服务处理程序(以支持Ajax框架异步调用Web服务方法)">
<meta name="twitter:description" content="当你添加Asp.net AJAX功能到你的Web程序的时候，你需要在Web.config中做一些改变，需要你显式地移除默认的ASMX处理程序并且添加asp.net ajax框架自己的脚本处理器来作为ASMX处理程序。在上一篇异步调用Web服务方法中，我们谈论过，ajax框架的asmx(ScriptHandler)是不支持异步调用Web服务方法的，所以为了让asp.netajax支持异步Web方法调">
  
    <link rel="alternative" href="/atom.xml" title="yanghua" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">yanghua</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">alone coder</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/projects">Projects</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/yanghua" target="_blank" title="GitHub"></a>
        
        
          <a id="nav-weibo-link" class="nav-icon" href="http://weibo.com/yanghua1127" target="_blank" title="Sina Weibo"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://vinoyang.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2011/12/05/开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法/" class="article-date">
  <time datetime="2011-12-04T18:22:00.000Z" itemprop="datePublished">2011-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      开发自己的Web服务处理程序(以支持Ajax框架异步调用Web服务方法)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <div><br><br>当你添加Asp.net AJAX功能到你的Web程序的时候，你需要在Web.config中做一些改变，需要你显式地移除默认的ASMX处理程序并且添加asp.net ajax框架自己的脚本处理器来作为ASMX处理程序。在上一篇<a href="http://blog.csdn.net/yanghua_kobe/article/details/6991689" target="_blank" rel="external">异步调用Web服务方法</a>中，我们谈论过，ajax框架的asmx(ScriptHandler)是不支持异步调用Web服务方法的，所以为了让asp.netajax支持异步Web方法调用，我们需要避开该处理器，以提供自定义的处理器来取代它。<br><br><a id="more"></a><br><br>&nbsp;<br><br><strong>Asp.netAJAX框架的ASMX处理器——ScriptHandler</strong><br><br>ScriptHandler是一个常规的HTTP处理程序，它能够通过解析URL找出调用了哪个Web服务及Web方法。然后对应于Web服务类型通过反射来执行Web方法。调用Web方法所涉及的步骤如下：<br><br>1、&nbsp; 通过检查Content-Type来确认这是一个基于Ajax的Web方法调用，并查看它是否有application/json的属性。如果没有，则激活一个异常。<br><br>2、&nbsp; 通过解析请求的URL找出哪个.asmx被调用，返回.asmx文件类型且被编译过的程序集。<br><br>3、&nbsp; 反射程序集并找出Web服务和被调用的Web方法<br><br>4、&nbsp; 反序列化输入参数到适当的数据类型中，以防Http POST反序列化JSON图表<br><br>5、&nbsp; 查看方法中的参数并映射每个参数到JSON反序列化的对象上<br><br>6、&nbsp; 初始化缓存策略<br><br>7、&nbsp; 通过反射调用方法并且传递与JSON匹配的参数&#20540;<br><br>8、&nbsp; 获取返回&#20540;。序列化返回&#20540;到JSON/XML<br><br>9、&nbsp; 发射JSON/XML作为响应<br><br><strong>基本的异步Web服务处理程序</strong><br><br>首先你需要一个Http处理程序，它将拦截所有对Web服务的调用。在Web.config的&lt;httphandlers&gt;节点下你需要映射该处理程序到<em>.asmx来进行扩展。默认情况下，asp.net ajax将映射到ScriptHandler来处理</em>.asmx扩展名类型的文件，因此需要用你自己的Http处理程序来取代它。<br><br>在提供的代码中，ASMXHttpHandler.cs是主要的HTTP处理程序类。ASMXHttpHandler类实现了IhttpAsyncHandler接口。调用Web服务期间，当该处理程序被调用的时候，asp.net框架会首先调用BeginProcessRequest方法。在该方法中，处理程序会解析锁请求的URL并找出调用了哪个Web服务的Web方法。<br><br><pre name="code" class="csharp">IAsyncResult IHttpAsyncHandler.BeginProcessRequest(HttpContext context, AsyncCallback cb, object extraData)<br>        {<br>            // Proper Content-Type header must be present in order to make a REST call<br>            if (!IsRestMethodCall(context.Request))<br>            {<br>                return GenerateErrorResponse(context, &quot;Not a valid REST call&quot;, extraData);<br>            }<br><br>            string methodName = context.Request.PathInfo.Substring(1);<br><br>            WebServiceDef wsDef = WebServiceHelper.GetWebServiceType(context, context.Request.FilePath);<br>            WebMethodDef methodDef = wsDef.Methods[methodName];<br><br>            if (null == methodDef) return GenerateErrorResponse(context, &quot;Web method not supported: &quot; + methodName, extraData);<br><br>            // GET request will only be allowed if the method says so<br>            if (context.Request.HttpMethod == &quot;GET&quot; &amp;&amp; !methodDef.IsGetAllowed)<br>                return GenerateErrorResponse(context, &quot;Http Get method not supported&quot;, extraData);<br><br>            context.Response.Filter = new ResponseFilter(context.Response);<br><br>            // If the method does not have a BeginXXX and EndXXX pair, execute it synchronously<br>            if (!methodDef.HasAsyncMethods)<br>            {</pre><br><br>WebServiceDef类对Type类进行了包装，同时还包含Web服务类型的一些信息。它维护了WebMethodDef类的集合项，其中每项都包含对某个Web方法的定义。WebMethodDef类为每个方法，与方法相关的特性、是否支持Http GET方式以及如果可能，对Begin和End方法对的引用都提供了一个名称。如果没有Begin和End方法对，该方法会如下例代码所示，以同步方式执行。所有的这些类都作为Web服务和Web方法进行缓存处理，因此不需要重复使用反射查看元数据。<br><br><pre name="code" class="csharp">// If the method does not have a BeginXXX and EndXXX pair, execute it synchronously<br>            if (!methodDef.HasAsyncMethods)<br>            {<br>                // Do synchronous call<br>                ExecuteMethod(context, methodDef, wsDef);<br><br>                // Return a result that says method was executed synchronously<br>                return new AsmxHandlerSyncResult(extraData);<br>            }</pre><br><br>当方法同步执行的时候，BeginProcessRequest将立即返回。它将返回一个AsmxHandlerSyncRequest实例，表示请求以按同步方式执行并且不需要出发EndProcessRequest方法。AsmxHandlerSyncRequest类实现了IasyncRequest接口。它会从CompletedSynchronously属性返回真&#20540;。<br><br><pre name="code" class="csharp">public class AsmxHandlerSyncResult : IAsyncResult<br>    {<br>        #region Fields<br><br>        private WaitHandle handle = new ManualResetEvent(true);<br>        private object state;<br><br>        #endregion Fields<br><br>        #region Constructors<br><br>        public AsmxHandlerSyncResult(object state)<br>        {<br>            this.state = state;<br>        }<br><br>        #endregion Constructors<br><br>        #region Properties<br><br>        object IAsyncResult.AsyncState<br>        {<br>            get { return this.state; }<br>        }<br><br>        WaitHandle IAsyncResult.AsyncWaitHandle<br>        {<br>            get { return this.handle; }<br>        }<br><br>        bool IAsyncResult.CompletedSynchronously<br>        {<br>            get { return true; }<br>        }<br><br>        bool IAsyncResult.IsCompleted<br>        {<br>            get { return true; }<br>        }<br><br>        #endregion Properties<br>    }</pre><br><br>回到BeginProcessRequest方法上，当存在Begin和End方法对的时候，它会调用Web方法的BeginXXX方法并从该方法返回。执行到Asp.net框架并返回线程到线程池。<br><br>下面的代码展示了调用Web服务上BeginXXX方法的准备步骤。首先，除了最后两个参数(一个是AsyncCallback，另一个是某个对象状态)，来自请求的所有参数都需要进行适当的映射。<br><br><pre name="code" class="csharp">else<br>            {<br>                // Call the Begin method of web service<br>                IDisposable target = Activator.CreateInstance(wsDef.WSType) as IDisposable;<br><br>                WebMethodDef beginMethod = methodDef.BeginMethod;<br>                int allParameterCount = beginMethod.InputParametersWithAsyc.Count;<br><br>                IDictionary&lt;string, object&gt; inputValues = GetRawParams(context, beginMethod.InputParameters, wsDef.Serializer);<br>                object[] parameterValues = StrongTypeParameters(inputValues, beginMethod.InputParameters);<br><br>                // Prepare the list of parameter values which will also include the AsyncCallback and the state<br>                object[] parameterValuesWithAsync = new object[allParameterCount];<br>                Array.Copy(parameterValues, parameterValuesWithAsync, parameterValues.Length);<br><br>                // Populate last two parameters with async callback and state<br>                parameterValuesWithAsync[allParameterCount - 2] = cb;<br><br>                AsyncWebMethodState webMethodState = new AsyncWebMethodState(methodName, target,<br>                    wsDef, methodDef, context, extraData);<br>                parameterValuesWithAsync[allParameterCount - 1] = webMethodState;</pre><br><br>注：Web服务从System.Web.Services.WebService命名空间继承，并实现了Idisposable接口。Activator.CreateInstance是.net框架类的一个实例，它能从自己的类型中动态实例化任何类并返回一个对象的引用。在上例代码中，Web服务类实例被创建，并且使用了对Idisposable接口的引用。使用Idisposable接口是因为当我们调用结束后需要释放占用的资源。<br><br>一旦准备工作完成，BeginXXX方法会被调用。现在BeginXXX方法能同步执行并立即返回。在这种情况下，你必须完整地产生BeginXXX方法的响应并完成该请求的执行。但是，如果BeginXXX方法需要更多的时间来异步执行的话，你需要为Asp.net框架返回该执行以便它把线程返回给线程池。当异步操作完成后，EndProcessRequest方法将执行回调并继续处理该请求。<br><br><pre name="code" class="csharp">try<br>                {<br>                    // Invoke the BeginXXX method and ensure the return result has AsyncWebMethodState. This state<br>                    // contains context and other information which we need in oreder to call the EndXXX<br>                    IAsyncResult result = beginMethod.MethodType.Invoke(target, parameterValuesWithAsync) as IAsyncResult;<br><br>                    // If execution has completed synchronously within the BeginXXX function, then generate response<br>                    // immediately. There’s no need to call EndXXX<br>                    if (result.CompletedSynchronously)<br>                    {<br>                        object returnValue = result.AsyncState;<br>                        GenerateResponse(returnValue, context, methodDef, wsDef);<br><br>                        target.Dispose();<br>                        return new AsmxHandlerSyncResult(extraData);<br>                    }<br>                    else<br>                    {<br>                        if (result.AsyncState is AsyncWebMethodState) return result;<br>                        else throw new InvalidAsynchronousStateException(&quot;The state passed in the &quot; + beginMethod.MethodName + &quot; must inherit from &quot; + typeof(AsyncWebMethodState).FullName);<br>                    }<br>                }<br>                catch (Exception x)<br>                {<br>                    target.Dispose();<br>                    WebServiceHelper.WriteExceptionJsonString(context, x, wsDef.Serializer);<br>                    return new AsmxHandlerSyncResult(extraData);<br>                }</pre><br><br>当异步操作完成并且回调被激活的时候，EndProcessRequest方法也被激活。例如，如果你异步调用某个外部Web服务其里面包含了命名为BeginXXX的Web方法，则你需要传递一个对AsyncCallback的引用。这会为你接受到的BeginProcessRequest执行同样的回调。Asp.net框架会给你创建一个回调的引用，你可以在HTTP处理程序中用Web服务的EndXXX方法来获得响应和产生输出。<br><br><pre name="code" class="csharp">void IHttpAsyncHandler.EndProcessRequest(IAsyncResult result)<br>        {<br>            if (result.CompletedSynchronously) return;<br><br>            AsyncWebMethodState state = result.AsyncState as AsyncWebMethodState;<br><br>            if (result.IsCompleted)<br>            {<br>                MethodInfo endMethod = state.MethodDef.EndMethod.MethodType;<br><br>                try<br>                {<br>                    object returnValue = endMethod.Invoke(state.Target, new object[] { result });<br>                    GenerateResponse(returnValue, state.Context, state.MethodDef, state.ServiceDef);<br>                }<br>                catch (Exception x)<br>                {<br>                    WebServiceHelper.WriteExceptionJsonString(state.Context, x, state.ServiceDef.Serializer);<br>                }<br>                finally<br>                {<br>                    state.Target.Dispose();<br>                }<br><br>                state.Dispose();<br>            }<br>        }</pre><br><br>当EndXXX类的Web方法调用完成后，如果该方法不是一个返回空类型的方法，你将得到一个返回&#20540;，在这种情况下，你需要把该返回&#20540;转换到某个JSON&#26684;式的字符串中并返回到浏览器端。然而，该方法也可以返回某个XML&#26684;式的字符串而取代JSON&#26684;式。因此，仅需要把这些字符串写入到HttpResponse对象即可。<br><br><pre name="code" class="csharp">private void GenerateResponse(object returnValue, HttpContext context, WebMethodDef methodDef, WebServiceDef serviceDef)<br>        {<br>            if (context.Response.Filter.Length &gt; 0)<br>            {<br>                // Response has already been transmitted by the WebMethod.<br>                // So, do nothing<br>                return;<br>            }<br>            string responseString = null;<br>            string contentType = &quot;application/json&quot;;<br><br>            if (methodDef.ResponseFormat == System.Web.Script.Services.ResponseFormat.Json)<br>            {<br>                responseString = &quot;{ d : (&quot; + serviceDef.Serializer.Serialize(returnValue) + &quot;)}&quot;;<br>                contentType = &quot;application/json&quot;;<br>            }<br>            else if (methodDef.ResponseFormat == System.Web.Script.Services.ResponseFormat.Xml)<br>            {<br>                responseString = returnValue as string;<br>                contentType = &quot;text/xml&quot;;<br>            }<br><br>            context.Response.ContentType = contentType;<br><br>            // If we have response and no redirection happening and client still connected, send response<br>            if (responseString != null<br>                &amp;&amp; !context.Response.IsRequestBeingRedirected<br>                &amp;&amp; context.Response.IsClientConnected)<br>            {<pre name="code" class="csharp">// Convert the response to response encoding, e.g. utf8<br>                byte[] unicodeBytes = Encoding.Unicode.GetBytes(responseString);<br>                byte[] utf8Bytes = Encoding.Convert(Encoding.Unicode, context.Response.ContentEncoding, unicodeBytes);<br><br>                // Emit content length in UTF8 encoding string<br>                context.Response.AppendHeader(&quot;Content-Length&quot;, utf8Bytes.Length.ToString());<br><br>                // Instead of Response.Write which will convert the output to UTF8, use the internal stream<br>                // to directly write the utf8 bytes<br>                context.Response.OutputStream.Write(utf8Bytes, 0, utf8Bytes.Length);<br>            }<br>            else<br>            {<br>                // Send no body as response and we will just abort it<br>                context.Response.AppendHeader(&quot;Content-Length&quot;, &quot;0&quot;);<br>                context.Response.ClearContent();<br>                context.Response.StatusCode = 204; // No Content<br>            }<br>        }</pre><br><br><pre></pre><br><br><strong>为Web方法添加事务化的能力</strong><br><br>到此为止，Web方法的执行并没有支持事务。可以使用[TransactionalMethod]特性来界定事务包括的范围、代码的隔离级别和超时时段。<br><br>带有TransactionalMethod特性的Web方法将在事务块中自动执行。这里我们将使用.net 2.0事务。事务管理完全在HTTP处理程序中执行并且Web方法并不需要做过多事情。当Web方法遇到异常的时候，事务会自动回滚；否则，事务将自动提交。<br><br>ASMXHttpHandler的ExecuteMethod方法同步调用Web方法并提供了事务支持。目前，由于从一个线程到另一个线程的不断转换，针对异步方法的事务支持还没有实现。所以TransactionScope从本地线程存储中的特性丢失了。<br><br><pre name="code" class="csharp">private void ExecuteMethod(HttpContext context, WebMethodDef methodDef, WebServiceDef serviceDef)<br>        {<br>            IDictionary&lt;string, object&gt; inputValues = GetRawParams(context, methodDef.InputParameters, serviceDef.Serializer);<br>            object[] parameters = StrongTypeParameters(inputValues, methodDef.InputParameters);<br><br>            object returnValue = null;<br>            using (IDisposable target = Activator.CreateInstance(serviceDef.WSType) as IDisposable)<br>            {<br>                TransactionScope ts = null;<br>                try<br>                {<br>                    // If the method has a transaction attribute, then call the method within a transaction scope<br>                    if (methodDef.TransactionAtt != null)<br>                    {<br>                        TransactionOptions options = new TransactionOptions();<br>                        options.IsolationLevel = methodDef.TransactionAtt.IsolationLevel;<br>                        options.Timeout = TimeSpan.FromSeconds( methodDef.TransactionAtt.Timeout );<br><br>                        ts = new TransactionScope(methodDef.TransactionAtt.TransactionOption, options);<br>                    }<br><br>                    returnValue = methodDef.MethodType.Invoke(target, parameters);<br><br>                    // If transaction was used, then complete the transaction because no exception was<br>                    // generated<br>                    if( null != ts ) ts.Complete();<br><br>                    GenerateResponse(returnValue, context, methodDef, serviceDef);<br>                }<br>                catch (Exception x)<br>                {<br>                    WebServiceHelper.WriteExceptionJsonString(context, x, serviceDef.Serializer);<br>                }<br>                finally<br>                {<br>                    // If transaction was started for the method, dispose the transaction. This will<br>                    // rollback if not committed<br>                    if( null != ts) ts.Dispose();<br><br>                    // Dispose the web service<br>                    target.Dispose();<br>                }<br>            }<br>        }</pre><br><br>上例代码展示了一个执行得当的Web方法并产生一个响应。该Web方法在一个定义为TransactionalMethod特性的事务范围块内执行。但是当Web方法抛出一个异常的时候，它会定位到出现异常消息块的地方。最终，TransactionScope被释放并会检查本次操作是否已经提交。如果没有提交，TransactionScope会回滚该事务。<br><br><pre name="code" class="csharp">catch (Exception x)<br>                {<br>                    WebServiceHelper.WriteExceptionJsonString(context, x, serviceDef.Serializer);<br>                }<br>                finally<br>                {<br>                    // If transaction was started for the method, dispose the transaction. This will<br>                    // rollback if not committed<br>                    if( null != ts) ts.Dispose();<br><br>                    // Dispose the web service<br>                    target.Dispose();<br>                }</pre><br><br>整个事务化管理都位于HTTP处理程序中，因此，不需要担心Web服务中的事务。仅需要添加一个特性，然后该Web方法就具有了事务特性。<br><br><strong>添加缓存头</strong><br><br>Asp.net Ajax框架在调用Web方法之前会进行缓存策略初始化操作。如果你没有在[WebMethod]属性中设置缓存持续时间，那么它将把MaxAge设置为零。一旦MaxAge被设置为零，就不能再对它增加。因此，为了从浏览器端获取缓存响应，你不能动态地从你的Web方法代码中增加MaxAge的&#20540;。而由于HttpCachePolicy的限制，一旦设定MaxAge的&#20540;，就不能再对它进行增加。此外，如果你使用Http检测工具来查看从Web服务调用返回的响应，你将会看到该响应丢失了Content-Length特性。没有该特性，浏览器不能使用Http管道，这将很大滴提升Http响应的下载时间。<br><br>&nbsp;<br><br>为了处理缓存策略，在GenerateResponse方法中作了一些补充。我们的想法是该Web方法在HttpResponse对象中已经设置了一些缓存策略，因此它将不会改变任何缓存设置。否则，它会进行缓存设置检查是否应用了WebMethod特性，然后设置缓存头。<br><br><pre name="code" class="csharp">// If we have response and no redirection happening and client still connected, send response<br>            if (responseString != null<br>                &amp;&amp; !context.Response.IsRequestBeingRedirected<br>                &amp;&amp; context.Response.IsClientConnected)<br>            {<br>                // Produce proper cache. If no cache information specified on method and there’s been no cache related<br>                // changes done within the web method code, then default cache will be private, no cache.<br>                if (IsCacheSet(context.Response) || methodDef.IsETagEnabled)<br>                {<br>                    // Cache has been modified within the code. So, do not change any cache policy<br>                }<br>                else<br>                {<br>                    // Cache is still private. Check if there’s any CacheDuration set in WebMethod<br>                    int cacheDuration = methodDef.WebMethodAtt.CacheDuration;<br>                    if (cacheDuration &gt; 0)<br>                    {<br>                        // If CacheDuration attribute is set, use server side caching<br>                        context.Response.Cache.SetCacheability(HttpCacheability.Server);<br>                        context.Response.Cache.SetExpires(DateTime.Now.AddSeconds(cacheDuration));<br>                        context.Response.Cache.SetSlidingExpiration(false);<br>                        context.Response.Cache.SetValidUntilExpires(true);<br><br>                        if (methodDef.InputParameters.Count &gt; 0)<br>                        {<br>                            context.Response.Cache.VaryByParams[&quot;<em>&quot;] = true;<br>                        }<br>                        else<br>                        {<br>                            context.Response.Cache.VaryByParams.IgnoreParams = true;<br>                        }<br>                    }<br>                    else<br>                    {<br>                        context.Response.Cache.SetNoServerCaching();<br>                        context.Response.Cache.SetMaxAge(TimeSpan.Zero);<br>                    }<br>                }<br><br>                // Check if there’s any need to do ETag match. If ETag matches, produce HTTP 304, otherwise<br>                // render the content along with the ETag<br>                if (methodDef.IsETagEnabled)<br>                {<br>                    string etag = context.Request.Headers[&quot;If-None-Match&quot;];<br>                    string hash = GetMd5Hash(responseString);<br><br>                    if (!string.IsNullOrEmpty(etag))<br>                    {<br>                        if (string.Compare(hash, etag, true) == 0)<br>                        {<br>                            // Send no body as response and we will just abort it<br>                            context.Response.ClearContent();<br>                            context.Response.AppendHeader(&quot;Content-Length&quot;, &quot;0&quot;);<br>                            context.Response.SuppressContent = true;<br>                            context.Response.StatusCode = 304;<br><br>                            // No need to produce output response body<br>                            return;<br>                        }<br>                    }<br><br>                    // ETag comparison did not happen or comparison did not match. So, we need to produce new ETag<br>                    HttpContext.Current.Response.Cache.SetCacheability(HttpCacheability.Public);<br>                    HttpContext.Current.Response.Cache.AppendCacheExtension(&quot;must-revalidate, proxy-revalidate&quot;);<br>                    HttpContext.Current.Response.Cache.SetETag(hash);<br>                    HttpContext.Current.Response.Cache.SetLastModified(DateTime.Now);<br><br>                    int cacheDuration = methodDef.WebMethodAtt.CacheDuration;<br>                    if (cacheDuration &gt; 0)<br>                    {<br>                        context.Response.Cache.SetExpires(DateTime.Now.AddMinutes(cacheDuration));<br>                        context.Response.Cache.SetMaxAge(TimeSpan.FromMinutes(cacheDuration));<br>                    }<br>                    else<br>                    {<br>                        context.Response.Cache.SetMaxAge(TimeSpan.FromSeconds(10));<br>                    }<br><br>                }<br><br>                // Convert the response to response encoding, e.g. utf8<br>                byte[] unicodeBytes = Encoding.Unicode.GetBytes(responseString);<br>                byte[] utf8Bytes = Encoding.Convert(Encoding.Unicode, context.Response.ContentEncoding, unicodeBytes);<br><br>                // Emit content length in UTF8 encoding string<br>                context.Response.AppendHeader(&quot;Content-Length&quot;, utf8Bytes.Length.ToString());<br><br>                // Instead of Response.Write which will convert the output to UTF8, use the internal stream<br>                // to directly write the utf8 bytes<br>                context.Response.OutputStream.Write(utf8Bytes, 0, utf8Bytes.Length);<br>            }</em></pre><br><br>IsCacheSet方法检查在一些通用的缓存设置中是否有任何变化。如果发生变化，Web方法本身需要对缓存进行处理（由框架完成），并且GenerateResponse方法对于缓存策略并没有发生任何改变。<br><br><pre name="code" class="csharp"> private bool IsCacheSet(HttpResponse response)<br>        {<br>            if (response.CacheControl == &quot;public&quot;) return true;<br><br>            FieldInfo maxAgeField = response.Cache.GetType().GetField(&quot;_maxAge&quot;, BindingFlags.GetField | BindingFlags.Instance | BindingFlags.NonPublic);<br>            TimeSpan maxAgeValue = (TimeSpan)maxAgeField.GetValue(response.Cache);<br><br>            if (maxAgeValue != TimeSpan.Zero) return true;<br><br>            return false;<br>        }</pre><br><br><em>*使用</em><br><br>只需在Web.config中将ScriptHandler处理器用该处理器替代即可。<br><br><span style="font-size:18px"><a href="http://download.csdn.net/detail/yanghua_kobe/3878998" target="_blank" rel="external">源代码下载</a></span><br><br>        <div style="padding-top:20px"><br><br>版权声明：本文为博主原创文章，未经博主允许不得转载。<br><br>        </div><br></pre></div>

<!-- Baidu Button BEGIN -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://vinoyang.com/2011/12/05/开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法/" data-id="cikbw7c7o0020ugz2edmmekja" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2011/12/12/细说Cookies/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          细说Cookies
        
      </div>
    </a>
  
  
    <a href="/2011/11/27/性能优化之页面缓存（以Javascript方式缓存页面部件）/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">性能优化之页面缓存（以Javascript方式缓存页面部件）</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法" data-title="开发自己的Web服务处理程序(以支持Ajax框架异步调用Web服务方法)" data-url="http://vinoyang.com/2011/12/05/开发自己的Web服务处理程序-以支持Ajax框架异步调用Web服务方法/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'vinoyang'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/async/">async</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/disque/">disque</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/messagebus/">messagebus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/morphline/">morphline</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rate-limit/">rate-limit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式锁/">分布式锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志系统/">日志系统</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息总线/">消息总线</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/async/" style="font-size: 10px;">async</a> <a href="/tags/disque/" style="font-size: 10px;">disque</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/flume/" style="font-size: 15px;">flume</a> <a href="/tags/messagebus/" style="font-size: 10px;">messagebus</a> <a href="/tags/morphline/" style="font-size: 10px;">morphline</a> <a href="/tags/rate-limit/" style="font-size: 10px;">rate-limit</a> <a href="/tags/redis/" style="font-size: 20px;">redis</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分布式锁/" style="font-size: 10px;">分布式锁</a> <a href="/tags/日志系统/" style="font-size: 20px;">日志系统</a> <a href="/tags/消息总线/" style="font-size: 20px;">消息总线</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">十月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">九月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">三月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">二月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">一月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">十二月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">十一月 2011</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">十月 2011</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">九月 2011</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08/">八月 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">七月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">六月 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">五月 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03/">三月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">二月 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">七月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">六月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/05/">五月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">四月 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">三月 2010</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02/">二月 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01/">一月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10/">十月 2009</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/02/07/collect-docker-container-log-with-flume/">日志系统之基于flume收集docker容器日志</a>
          </li>
        
          <li>
            <a href="/2016/02/05/日志系统重构之多源聚合的采集器/">日志系统重构之多源聚合的采集器</a>
          </li>
        
          <li>
            <a href="/2015/12/26/link-log-system-component-with-zookeeper/">日志系统之基于Zookeeper的分布式协同设计</a>
          </li>
        
          <li>
            <a href="/2015/12/11/messagebus-refactor-model/">消息总线之模型重构</a>
          </li>
        
          <li>
            <a href="/2015/11/20/build-log-sys-with-flume-and-morphline/">日志系统之Flume采集加morphline解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Weibo show</h3>
    <div class="widget-weibo">
      <iframe width="100%" height="450" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=2&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1958166695&verifier=9c2d28b9&colors=dddddd,dddddd,666666,0069a4,dddddd&dpc=1"></iframe>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Github</h3>
    <div class="widget-github">
      <script data-name="yanghua" src="http://octocard.in/o.js"></script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 yanghua1127@gmail.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/projects" class="mobile-nav-link">Projects</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
//<![CDATA[
if (typeof jQuery == 'undefined') {
  document.write(unescape("%3Cscript src='/js/jquery-2.0.3.min.js' type='text/javascript'%3E%3C/script%3E"));
}
// ]]>
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?36c1573c11e45ea0f6419af5f2f04760";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  </div>
</body>
</html>