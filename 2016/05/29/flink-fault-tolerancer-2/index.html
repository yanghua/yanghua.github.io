<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6q22x_DFglYGJjD5t1d95nBYd_U8cDU04B-Haky8KHs" />
  <meta name="baidu-site-verification" content="yEdVDDBr1C" />
  
  <title>Apache Flink fault tolerance源码剖析(二) | yanghua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="继续Flink Fault Tolerance机制剖析。上一篇文章我们结合代码讲解了Flink中检查点是如何应用的（如何根据快照做失败恢复，以及检查点被应用的场景），这篇我们来谈谈检查点的触发机制以及基于Actor的消息驱动的协同机制。这篇涉及到一个非常关键的类——CheckpointCoordinator。">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Flink fault tolerance源码剖析(二)">
<meta property="og:url" content="http://vinoyang.com/2016/05/29/flink-fault-tolerancer-2/index.html">
<meta property="og:site_name" content="yanghua">
<meta property="og:description" content="继续Flink Fault Tolerance机制剖析。上一篇文章我们结合代码讲解了Flink中检查点是如何应用的（如何根据快照做失败恢复，以及检查点被应用的场景），这篇我们来谈谈检查点的触发机制以及基于Actor的消息驱动的协同机制。这篇涉及到一个非常关键的类——CheckpointCoordinator。">
<meta property="og:image" content="http://7xkaaz.com1.z0.glb.clouddn.com/flink-fault-tolerance-2_message-class-diagram.png">
<meta property="og:image" content="http://7xkaaz.com1.z0.glb.clouddn.com/Apache_Flink_weixin.jpg">
<meta property="og:image" content="http://7xkaaz.com1.z0.glb.clouddn.com/qrcode_for_apache_flink_qq_group.png">
<meta property="og:updated_time" content="2016-05-29T12:35:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apache Flink fault tolerance源码剖析(二)">
<meta name="twitter:description" content="继续Flink Fault Tolerance机制剖析。上一篇文章我们结合代码讲解了Flink中检查点是如何应用的（如何根据快照做失败恢复，以及检查点被应用的场景），这篇我们来谈谈检查点的触发机制以及基于Actor的消息驱动的协同机制。这篇涉及到一个非常关键的类——CheckpointCoordinator。">
  
    <link rel="alternative" href="/atom.xml" title="yanghua" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">yanghua</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">alone coder</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/projects">Projects</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/yanghua" target="_blank" title="GitHub"></a>
        
        
          <a id="nav-weibo-link" class="nav-icon" href="http://weibo.com/yanghua1127" target="_blank" title="Sina Weibo"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://vinoyang.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-flink-fault-tolerancer-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/flink-fault-tolerancer-2/" class="article-date">
  <time datetime="2016-05-29T12:34:03.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Apache Flink fault tolerance源码剖析(二)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
          <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#周期性的检查点触发机制"><span class="toc-number">1.</span> <span class="toc-text">周期性的检查点触发机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ScheduledTrigger"><span class="toc-number">1.1.</span> <span class="toc-text">ScheduledTrigger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#startCheckpointScheduler"><span class="toc-number">1.2.</span> <span class="toc-text">startCheckpointScheduler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stopCheckpointScheduler"><span class="toc-number">1.3.</span> <span class="toc-text">stopCheckpointScheduler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#triggerCheckpoint"><span class="toc-number">1.4.</span> <span class="toc-text">triggerCheckpoint</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基于Actor的消息驱动的协同机制"><span class="toc-number">2.</span> <span class="toc-text">基于Actor的消息驱动的协同机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractCheckpointMessage"><span class="toc-number">2.1.</span> <span class="toc-text">AbstractCheckpointMessage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TriggerCheckpoint"><span class="toc-number">2.2.</span> <span class="toc-text">TriggerCheckpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#触发消息"><span class="toc-number">2.2.1.</span> <span class="toc-text">触发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息处理"><span class="toc-number">2.2.2.</span> <span class="toc-text">消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DeclineCheckpoint"><span class="toc-number">2.3.</span> <span class="toc-text">DeclineCheckpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#触发消息-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">触发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息处理-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AcknowledgeCheckpoint"><span class="toc-number">2.4.</span> <span class="toc-text">AcknowledgeCheckpoint</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#触发消息-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">触发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息处理-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NotifyCheckpointComplete"><span class="toc-number">2.5.</span> <span class="toc-text">NotifyCheckpointComplete</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#触发消息-3"><span class="toc-number">2.5.1.</span> <span class="toc-text">触发消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息处理-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">消息处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#小结"><span class="toc-number">3.</span> <span class="toc-text">小结</span></a></li></ol>
          </div>
        
        <p>继续<strong>Flink Fault Tolerance</strong>机制剖析。上一篇文章我们结合代码讲解了Flink中检查点是如何应用的（如何根据快照做失败恢复，以及检查点被应用的场景），这篇我们来谈谈检查点的触发机制以及基于<code>Actor</code>的消息驱动的协同机制。这篇涉及到一个非常关键的类——<code>CheckpointCoordinator</code>。</p>
<a id="more"></a>
<blockquote>
<p>org.apache.flink.runtime.checkpoint.CheckpointCoordinator</p>
</blockquote>
<p>该类可以理解为检查点的<strong>协调器</strong>，用来协调<code>operator</code>和<code>state</code>的分布式快照。</p>
<h1 id="周期性的检查点触发机制">周期性的检查点触发机制</h1><p>检查点的触发机制是基于<strong>定时器的周期性触发</strong>。这涉及到一个定时器的实现类<code>ScheduledTrigger</code></p>
<h2 id="ScheduledTrigger">ScheduledTrigger</h2><p>触发检查点的定时任务类。其实现就是调用<code>triggerCheckpoint</code>方法。这个方法后面会具体介绍。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		triggerCheckpoint(System.currentTimeMillis());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		LOG.<span class="keyword">error</span>(<span class="string">"Exception while triggering checkpoint"</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="startCheckpointScheduler">startCheckpointScheduler</h2><p>启动触发检查点的定时任务的方法实现：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startCheckpointScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">		<span class="keyword">if</span> (shutdown) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Checkpoint coordinator is shut down"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make sure all prior timers are cancelled</span></span><br><span class="line">		stopCheckpointScheduler();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// Multiple start calls are OK</span></span><br><span class="line">			checkpointIdCounter.start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			String msg = <span class="string">"Failed to start checkpoint ID counter: "</span> + e.getMessage();</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		periodicScheduling = <span class="keyword">true</span>;</span><br><span class="line">		currentPeriodicTrigger = <span class="keyword">new</span> ScheduledTrigger();</span><br><span class="line">		timer.scheduleAtFixedRate(currentPeriodicTrigger, baseInterval, baseInterval);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法的实现包含两个主要动作：</p>
<ul>
<li>启动检查点ID计数器<code>checkpointIdCounter</code></li>
<li>启动触发检查点的定时任务</li>
</ul>
<h2 id="stopCheckpointScheduler">stopCheckpointScheduler</h2><p>关闭定时任务的方法，用来释放资源，重置一些标记变量。</p>
<h2 id="triggerCheckpoint">triggerCheckpoint</h2><p>该方法是触发一个新的检查点的核心逻辑。</p>
<p>首先，方法中会去判断一个flag:<code>triggerRequestQueued</code>。该标识表示是否一个检查点的触发请求<strong>不能</strong>被立即执行。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sanity check: there should never be more than one trigger request queued</span></span><br><span class="line"><span class="keyword">if</span> (triggerRequestQueued) &#123;</span><br><span class="line">	<span class="keyword">LOG</span><span class="built_in">.</span>warn(<span class="string">"Trying to trigger another checkpoint while one was queued already"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不能被立即执行，则直接返回。</p>
<blockquote>
<p>不能被立即执行的原因是：还有其他处理没有完成。</p>
</blockquote>
<p>接着检查正在并发处理的未完成的检查点：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if too many checkpoints are currently in progress, we need to mark that a request is queued</span></span><br><span class="line"><span class="keyword">if</span> (pendingCheckpoints.<span class="keyword">size</span>() &gt;= maxConcurrentCheckpointAttempts) &#123;</span><br><span class="line">	triggerRequestQueued = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (currentPeriodicTrigger != <span class="keyword">null</span>) &#123;</span><br><span class="line">		currentPeriodicTrigger.cancel();</span><br><span class="line">		currentPeriodicTrigger = <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果未完成的检查点过多，大于允许的并发处理的检查点数目的阈值，则将当前检查点的触发请求设置为不能立即执行，如果定时任务已经启动，则取消定时任务的执行，并返回。</p>
<blockquote>
<p>以上这些检查处于基于锁机制实现的同步代码块中。</p>
</blockquote>
<p>接着检查需要被触发检查点的<code>task</code>是否都处于运行状态：</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutionAttemptID</span><span class="literal">[]</span> triggerIDs = new <span class="type">ExecutionAttemptID</span>[tasksToTrigger.length];</span><br><span class="line">for (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; tasksToTrigger.length; i++) &#123;</span><br><span class="line">	<span class="type">Execution</span> ee = tasksToTrigger[i].getCurrentExecutionAttempt<span class="literal">()</span>;</span><br><span class="line">	<span class="keyword">if</span> (ee != null &amp;&amp; ee.getState<span class="literal">()</span> == <span class="type">ExecutionState</span>.<span class="type">RUNNING</span>) &#123;</span><br><span class="line">		triggerIDs[i] = ee.getAttemptId<span class="literal">()</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">LOG</span>.info(<span class="string">"Checkpoint triggering task &#123;&#125; is not being executed at the moment. Aborting checkpoint."</span>,</span><br><span class="line">				tasksToTrigger[i].getSimpleName<span class="literal">()</span>);</span><br><span class="line">		return <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要有一个<code>task</code>不满足条件，则不会触发检查点，并立即返回。</p>
<p>然后检查是否所有需要ack检查点的<code>task</code>都处于运行状态：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;ExecutionAttemptID, ExecutionVertex&gt; ackTasks = <span class="keyword">new</span> HashMap&lt;&gt;(tasksToWaitFor.length);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ExecutionVertex ev : tasksToWaitFor) &#123;</span><br><span class="line">	Execution ee = ev.getCurrentExecutionAttempt();</span><br><span class="line">	<span class="keyword">if</span> (ee != <span class="keyword">null</span>) &#123;</span><br><span class="line">		ackTasks.put(ee.getAttemptId(), ev);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		LOG.info(<span class="string">"Checkpoint acknowledging task &#123;&#125; is not being executed at the moment. Aborting checkpoint."</span>,</span><br><span class="line">				ev.getSimpleName());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有一个<code>task</code>不满足条件，则不会触发检查点，并立即返回。</p>
<p>以上条件都满足（即没有<code>return false;</code>），才具备触发一个检查点的基本条件。</p>
<p>下一步，获得<code>checkpointId</code>：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> checkpointID;</span><br><span class="line"><span class="keyword">if</span> (nextCheckpointId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// this must happen outside the locked scope, because it communicates</span></span><br><span class="line">		<span class="comment">// with external services (in HA mode) and may block for a while.</span></span><br><span class="line">		checkpointID = checkpointIdCounter.getAndIncrement();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">		<span class="keyword">int</span> numUnsuccessful = ++numUnsuccessfulCheckpointsTriggers;</span><br><span class="line">		LOG.warn(<span class="string">"Failed to trigger checkpoint ("</span> + numUnsuccessful + <span class="string">" consecutive failed attempts so far)"</span>, t);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">	checkpointID = nextCheckpointId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这依赖于该方法的另一个参数<code>nextCheckpointId</code>，如果其值为<code>-1</code>，则起到标识的作用，指示<code>checkpointId</code>将从外部获取（比如<code>Zookeeper</code>，后续文章会谈及检查点ID的生成机制）。</p>
<p>接着创建一个<code>PendingCheckpoint</code>对象：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> PendingCheckpoint checkpoint = <span class="keyword">new</span> PendingCheckpoint(job, checkpointID, timestamp, ackTasks);</span><br></pre></td></tr></table></figure>
<p>该类表示一个待处理的检查点。</p>
<p>与此同时，会定义一个针对当前检查点<strong>超时</strong>进行资源清理的取消器<code>canceller</code>。该取消器主要是针对检查点没有释放资源的情况进行资源释放操作，同时还会调用<code>triggerQueuedRequests</code>方法启动一个触发检查点的定时任务，如果有的话（取决于<code>triggerRequestQueued</code>是否为true）。</p>
<p>然后会再次进入同步代码段，对上面的是否新建检查点的判断条件做二次检查，防止产生竞态条件。这里做二次检查的原因是，中间有一段关于获得<code>checkpointId</code>的代码，不在同步块中。</p>
<p>检查后，如果触发检查点的条件仍然是满足的，那么将上面创建的<code>PendingCheckpoint</code>对象加入集合中：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pendingCheckpoints.<span class="keyword">put</span>(checkpointID, checkpoint);</span><br></pre></td></tr></table></figure>
<p>同时会启动针对当前检查点的超时取消器：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">timer</span><span class="class">.schedule</span>(<span class="tag">canceller</span>, <span class="tag">checkpointTimeout</span>);</span><br></pre></td></tr></table></figure>
<p>接下来会发送消息给<code>task</code>以真正触发检查点（基于消息驱动的协同机制）：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; tasksToTrigger.<span class="property">length</span>; i++) &#123;</span><br><span class="line">	ExecutionAttemptID <span class="property">id</span> = triggerIDs[i];</span><br><span class="line">	TriggerCheckpoint message = new TriggerCheckpoint(job, <span class="property">id</span>, checkpointID, timestamp);</span><br><span class="line">	tasksToTrigger[i].sendMessageToCurrentExecution(message, <span class="property">id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="基于Actor的消息驱动的协同机制">基于Actor的消息驱动的协同机制</h1><p>上面已经谈到了检查点的触发机制是基于定时任务的周期性触发，那么定时任务的启停机制又是什么？Flink使用的是基于AKKA的Actor模型的消息驱动机制。</p>
<p>类<code>CheckpointCoordinatorDeActivator</code>是一个<code>Actor</code>的实现，它用于基于消息来驱动检查点的定时任务的启停：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Object <span class="class"><span class="keyword">message</span>) &#123;</span></span><br><span class="line">	if (<span class="class"><span class="keyword">message</span> <span class="title">instanceof</span> ExecutionGraphMessages.JobStatusChanged) </span>&#123;</span><br><span class="line"><span class="constant">		JobStatus status</span> = ((ExecutionGraphMessages.JobStatusChanged) <span class="class"><span class="keyword">message</span>).<span class="title">newJobStatus</span>();</span><br><span class="line">		</span><br><span class="line">		if (status == JobStatus.RUNNING) </span>&#123;</span><br><span class="line">			<span class="comment">// start the checkpoint scheduler</span></span><br><span class="line">			coordinator.startCheckpointScheduler();</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			<span class="comment">// anything else should stop the trigger for now</span></span><br><span class="line">			coordinator.stopCheckpointScheduler();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// we ignore all other messages</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>Actor</code>会收到<code>Job</code>状态的变化通知：<code>JobStatusChanged</code>。一旦变成<code>RUNNING</code>，那么检查点的定时任务会被立即启动；否则会被立即关闭。</p>
<p>该<code>Actor</code>被创建的代码是<code>CheckpointCoordinator</code>中的<code>createActivatorDeactivator</code>方法：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">ActorGateway <span class="title">createActivatorDeactivator</span><span class="params">(ActorSystem actorSystem, UUID leaderSessionID)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">		<span class="keyword">if</span> (shutdown) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Checkpoint coordinator is shut down"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (jobStatusListener == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Props props = Props.create(CheckpointCoordinatorDeActivator.class, <span class="keyword">this</span>, leaderSessionID);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// wrap the ActorRef in a AkkaActorGateway to support message decoration</span></span><br><span class="line">			jobStatusListener = <span class="keyword">new</span> AkkaActorGateway(actorSystem.actorOf(props), leaderSessionID);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> jobStatusListener;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然，是基于消息驱动机制，那么就需要各种类型的消息对应不同的业务逻辑。这些消息在Flink中被定义在package:<code>org.apache.flink.runtime.messages.checkpoint</code>中。</p>
<p>类图如下：</p>
<p><img src="http://7xkaaz.com1.z0.glb.clouddn.com/flink-fault-tolerance-2_message-class-diagram.png" alt="flink-fault-tolerance-2_message-class-diagram"></p>
<h2 id="AbstractCheckpointMessage">AbstractCheckpointMessage</h2><p>检查点消息的基础抽象类，提供了三个公共属性（从构造器注入）：</p>
<ul>
<li>job：<code>JobID</code>的实例，表示当前这条消息实例的归属；</li>
<li>taskExecutionId：<code>ExecutionAttemptID</code>的实例，表示检查点的源/目的任务</li>
<li>checkpointId：当前消息协调的检查点ID</li>
</ul>
<p>除此之外，该实现仅仅override了<code>hashCode</code>和<code>equals</code>方法。</p>
<h2 id="TriggerCheckpoint">TriggerCheckpoint</h2><p>该消息由<code>JobManager</code>发送给<code>TaskManager</code>，用于告诉一个<code>task</code>触发它的检查点。</p>
<h3 id="触发消息">触发消息</h3><p>位于<code>CheckpointCoordinator</code>类的<code>triggerCheckpoint</code>中，上面已经提及过。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; tasksToTrigger.<span class="property">length</span>; i++) &#123;</span><br><span class="line">	ExecutionAttemptID <span class="property">id</span> = triggerIDs[i];</span><br><span class="line">	TriggerCheckpoint message = new TriggerCheckpoint(job, <span class="property">id</span>, checkpointID, timestamp);</span><br><span class="line">	tasksToTrigger[i].sendMessageToCurrentExecution(message, <span class="property">id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消息处理">消息处理</h3><p><code>TaskManager</code>的<code>handleCheckpointingMessage</code>实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">case message: TriggerCheckpoint =&gt;</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> taskExecutionId</span> = message.getTaskExecutionId</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> checkpointId</span> = message.getCheckpointId</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> timestamp</span> = message.getTimestamp</span><br><span class="line">  </span><br><span class="line">  log.debug(s<span class="string">"Receiver TriggerCheckpoint $checkpointId@$timestamp for $taskExecutionId."</span>)</span><br><span class="line"></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> task</span> = runningTasks.<span class="keyword">get</span>(taskExecutionId)</span><br><span class="line">  <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">    task.triggerCheckpointBarrier(checkpointId, timestamp)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.debug(s<span class="string">"TaskManager received a checkpoint request for unknown task $taskExecutionId."</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>主要是触发检查点屏障<code>Barrier</code>。</p>
<h2 id="DeclineCheckpoint">DeclineCheckpoint</h2><p>该消息由<code>TaskManager</code>发送给<code>JobManager</code>，用于告诉检查点协调器：检查点的请求还没有能够被处理。这种情况通常发生于：某<code>task</code>已处于<code>RUNNING</code>状态，但在内部可能还没有准备好执行检查点。</p>
<p>它除了<code>AbstractCheckpointMessage</code>需要的三个属性外，还需要用于关联检查点的<code>timestamp</code>。</p>
<h3 id="触发消息-1">触发消息</h3><p>位于<code>Task</code>类的<code>triggerCheckpointBarrier</code>方法中：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">boolean</span> success = statefulTask.triggerCheckpoint(checkpointID, checkpointTimestamp);</span><br><span class="line">			<span class="keyword">if</span> (!success) &#123;</span><br><span class="line">				DeclineCheckpoint decline = <span class="keyword">new</span> DeclineCheckpoint(jobId, getExecutionId(), checkpointID, checkpointTimestamp);</span><br><span class="line">				jobManager.tell(decline);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			<span class="keyword">if</span> (getExecutionState() == ExecutionState.RUNNING) &#123;</span><br><span class="line">				failExternally(<span class="keyword">new</span> RuntimeException(</span><br><span class="line">					<span class="string">"Error while triggering checkpoint for "</span> + taskName,</span><br><span class="line">					t));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="消息处理-1">消息处理</h3><p>位于<code>JobManager</code>的<code>handleCheckpointMessage</code>中</p>
<p>具体的实现在<code>CheckpointCoordinator</code>的<code>receiveDeclineMessage</code>中：</p>
<p>首先从接收的消息中(<code>DeclineCheckpoint</code>)获得检查点编号：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> checkpointId = message.getCheckpointId();</span><br></pre></td></tr></table></figure>
<p>接下来的逻辑是判断当前检查点是否是未完成的检查点：<code>isPendingCheckpoint</code></p>
<p>接下来分为三种情况对待：</p>
<ul>
<li>如果是未完成的检查点，并且相关资源没有被释放（检查点没有被<code>discarded</code>）</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">isPendingCheckpoint = true<span class="comment">;</span></span><br><span class="line">pendingCheckpoints.remove(checkpointId)<span class="comment">;</span></span><br><span class="line">checkpoint.discard(userClassLoader)<span class="comment">;</span></span><br><span class="line">rememberRecentCheckpointId(checkpointId)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>置<code>isPendingCheckpoint</code>为<code>true</code>，根据检查点编号，将检查点从未完成的检查点集合中移除，<code>discard</code>检查点，记住最近的检查点（将其保持到到一个最近的检查点列表中）。</p>
<p>接下来查找是否还有待处理的检查点，根据检查点时间戳来判断：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">boolean haveMoreRecentPending = <span class="literal">false</span>;</span><br><span class="line"><span class="type">Iterator</span>&lt;<span class="type">Map</span>.<span class="type">Entry</span>&lt;<span class="type">Long</span>, <span class="type">PendingCheckpoint</span>&gt;&gt; entries = pendingCheckpoints.entrySet().<span class="keyword">iterator</span>();</span><br><span class="line"><span class="keyword">while</span> (entries.hasNext()) &#123;</span><br><span class="line">	<span class="type">PendingCheckpoint</span> p = entries.next().getValue();</span><br><span class="line">	<span class="keyword">if</span> (!p.isDiscarded() &amp;&amp; p.getCheckpointTimestamp() &gt;= checkpoint.getCheckpointTimestamp()) &#123;</span><br><span class="line">		haveMoreRecentPending = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据标识<code>haveMoreRecentPending</code>来进入不同的处理逻辑：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!haveMoreRecentPending &amp;&amp; !triggerRequestQueued) &#123;</span><br><span class="line">	<span class="built_in">LOG</span>.info(<span class="string">"Triggering new checkpoint because of discarded checkpoint "</span> + checkpointId)<span class="comment">;</span></span><br><span class="line">	triggerCheckpoint(System.currentTimeMillis())<span class="comment">;</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!haveMoreRecentPending) &#123;</span><br><span class="line">	<span class="built_in">LOG</span>.info(<span class="string">"Promoting queued checkpoint request because of discarded checkpoint "</span> + checkpointId)<span class="comment">;</span></span><br><span class="line">	triggerQueuedRequests()<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有需要处理的检查点，并且当前能立即处理，则立即触发检查点定时任务；如果有需要处理的检查点，但不能立即处理，则触发入队的定时任务。</p>
<ul>
<li>如果是未完成的检查点，并且检查点已经被<code>discarded</code></li>
</ul>
<p>抛出<code>IllegalStateException</code>异常</p>
<ul>
<li>如果不是未完成的检查点</li>
</ul>
<p>如果在最近未完成的检查点列表中找到，则有可能表示消息来迟了，将<code>isPendingCheckpoint</code>置为<code>true</code>，否则将<code>isPendingCheckpoint</code>置为<code>false</code>.</p>
<p>最后返回<code>isPendingCheckpoint</code>。</p>
<h2 id="AcknowledgeCheckpoint">AcknowledgeCheckpoint</h2><p>该消息是一个应答信号，表示某个独立的<code>task</code>的检查点已经完成。也是由<code>TaskManager</code>发送给<code>JobManager</code>。该消息会携带<code>task</code>的状态：</p>
<ul>
<li>state</li>
<li>stateSize</li>
</ul>
<h3 id="触发消息-2">触发消息</h3><p><code>RuntimeEnvironment</code>类的<code>acknowledgeCheckpoint</code>方法。</p>
<h3 id="消息处理-2">消息处理</h3><p>具体的实现在<code>CheckpointCoordinator</code>的<code>receiveAcknowledgeMessage</code>中，开始的实现同<code>receiveDeclineMessage</code>，也是判断当前接收到的消息中包含的检查点是否是待处理的检查点。如果是，并且也没有<code>discard</code>掉，则执行如下逻辑：</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (checkpoint.acknowledgeTask(message.getTaskExecutionId<span class="literal">()</span>, message.getState<span class="literal">()</span>, message.getStateSize<span class="literal">()</span>)) &#123;</span><br><span class="line">	<span class="keyword">if</span> (checkpoint.isFullyAcknowledged<span class="literal">()</span>) &#123;</span><br><span class="line">		completed = checkpoint.toCompletedCheckpoint<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">		completedCheckpointStore.addCheckpoint(completed);</span><br><span class="line"></span><br><span class="line">		<span class="type">LOG</span>.info(<span class="string">"Completed checkpoint "</span> + checkpointId + <span class="string">" (in "</span> +</span><br><span class="line">				completed.getDuration<span class="literal">()</span> + <span class="string">" ms)"</span>);</span><br><span class="line">		<span class="type">LOG</span>.debug(completed.getStates<span class="literal">()</span>.toString<span class="literal">()</span>);</span><br><span class="line"></span><br><span class="line">		pendingCheckpoints.remove(checkpointId);</span><br><span class="line">		rememberRecentCheckpointId(checkpointId);</span><br><span class="line"></span><br><span class="line">		dropSubsumedCheckpoints(completed.getTimestamp<span class="literal">()</span>);</span><br><span class="line"></span><br><span class="line">		onFullyAcknowledgedCheckpoint(completed);</span><br><span class="line"></span><br><span class="line">		triggerQueuedRequests<span class="literal">()</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查点首先应答相关的<code>task</code>，如果检查点已经完全应答完成，则将检查点转换成<code>CompletedCheckpoint</code>，然后将其加入<code>completedCheckpointStore</code>列表，并从<code>pendingCheckpoints</code>中移除。然后调用<code>dropSubsumedCheckpoints</code>它会从<code>pendingCheckpoints</code>中<code>diacard</code>所有时间戳小于当前检查点的时间戳，并从集合中移除。</p>
<p>最后，如果该检查点被转化为已完成的检查点，则：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (completed != <span class="literal">null</span>) &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="typename">long</span> timestamp = completed.getTimestamp();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (ExecutionVertex <span class="string">ev :</span> tasksToCommitTo) &#123;</span><br><span class="line">		Execution ee = ev.getCurrentExecutionAttempt();</span><br><span class="line">		<span class="keyword">if</span> (ee != <span class="literal">null</span>) &#123;</span><br><span class="line">			ExecutionAttemptID attemptId = ee.getAttemptId();</span><br><span class="line">			NotifyCheckpointComplete notifyMessage = <span class="keyword">new</span> NotifyCheckpointComplete(job, attemptId, checkpointId, timestamp);</span><br><span class="line">			ev.sendMessageToCurrentExecution(notifyMessage, ee.getAttemptId());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	statsTracker.onCompletedCheckpoint(completed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>迭代所有待commit的<code>task</code>，发送<code>NotifyCheckpointComplete</code>消息。同时触发状态跟踪器的<code>onCompletedCheckpoint</code>回调方法。</p>
<h2 id="NotifyCheckpointComplete">NotifyCheckpointComplete</h2><p>该消息由<code>JobManager</code>发送给<code>TaskManager</code>，用于告诉一个<code>task</code>它的检查点已经得到完成确认，<code>task</code>可以向第三方提交该检查点。</p>
<h3 id="触发消息-3">触发消息</h3><p>位于<code>CheckpointCoordinator</code>类的<code>receiveAcknowledgeMessage</code>方法中，当检查点ack<code>task</code>完成，转化为<code>CompletedCheckpoint</code>之后</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (completed != <span class="literal">null</span>) &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="typename">long</span> timestamp = completed.getTimestamp();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (ExecutionVertex <span class="string">ev :</span> tasksToCommitTo) &#123;</span><br><span class="line">		Execution ee = ev.getCurrentExecutionAttempt();</span><br><span class="line">		<span class="keyword">if</span> (ee != <span class="literal">null</span>) &#123;</span><br><span class="line">			ExecutionAttemptID attemptId = ee.getAttemptId();</span><br><span class="line">			NotifyCheckpointComplete notifyMessage = <span class="keyword">new</span> NotifyCheckpointComplete(job, attemptId, checkpointId, timestamp);</span><br><span class="line">			ev.sendMessageToCurrentExecution(notifyMessage, ee.getAttemptId());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	statsTracker.onCompletedCheckpoint(completed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消息处理-3">消息处理</h3><p><code>TaskManager</code>的<code>handleCheckpointingMessage</code></p>
<p>实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">case message: NotifyCheckpointComplete =&gt;</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> taskExecutionId</span> = message.getTaskExecutionId</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> checkpointId</span> = message.getCheckpointId</span><br><span class="line">  <span class="variable"><span class="keyword">val</span> timestamp</span> = message.getTimestamp</span><br><span class="line"></span><br><span class="line">  log.debug(s<span class="string">"Receiver ConfirmCheckpoint $checkpointId@$timestamp for $taskExecutionId."</span>)</span><br><span class="line"></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> task</span> = runningTasks.<span class="keyword">get</span>(taskExecutionId)</span><br><span class="line">  <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">    task.notifyCheckpointComplete(checkpointId)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.debug(</span><br><span class="line">      s<span class="string">"TaskManager received a checkpoint confirmation for unknown task $taskExecutionId."</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>主要是触发<code>task</code>的<code>notifyCheckpointComplete</code>方法。</p>
<h1 id="小结">小结</h1><p>这篇文章主要讲解了检查点的基于定时任务的周期性的触发机制，以及基于Akka的<code>Actor</code>模型的消息驱动的协同处理机制。</p>
<hr>
<blockquote>
<p>微信扫码关注公众号：Apache_Flink</p>
</blockquote>
<p><img src="http://7xkaaz.com1.z0.glb.clouddn.com/Apache_Flink_weixin.jpg" alt="apache_flink_weichat"></p>
<hr>
<blockquote>
<p>QQ扫码关注QQ群：Apache Flink学习交流群（123414680）</p>
</blockquote>
<p><img src="http://7xkaaz.com1.z0.glb.clouddn.com/qrcode_for_apache_flink_qq_group.png" alt="qrcode_for_apache_flink_qq_group"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://vinoyang.com/2016/05/29/flink-fault-tolerancer-2/" data-id="ciuv3gzmu005s9qz2l36o0for" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flink/">Flink</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/02/flink-fault-tolerance-3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Apache Flink fault tolerance源码剖析(三)
        
      </div>
    </a>
  
  
    <a href="/2016/05/26/flink-fault-tolerancer-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Apache Flink fault tolerance源码剖析(一)</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-flink-fault-tolerancer-2" data-title="Apache Flink fault tolerance源码剖析(二)" data-url="http://vinoyang.com/2016/05/29/flink-fault-tolerancer-2/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'vinoyang'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Akka/">Akka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/">Flink</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/async/">async</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/disque/">disque</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/messagebus/">messagebus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/morphline/">morphline</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/quartz/">quartz</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rate-limit/">rate-limit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式锁/">分布式锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志系统/">日志系统</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息总线/">消息总线</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Akka/" style="font-size: 10px;">Akka</a> <a href="/tags/Flink/" style="font-size: 20px;">Flink</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Zookeeper/" style="font-size: 12.5px;">Zookeeper</a> <a href="/tags/async/" style="font-size: 10px;">async</a> <a href="/tags/disque/" style="font-size: 10px;">disque</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/flume/" style="font-size: 15px;">flume</a> <a href="/tags/messagebus/" style="font-size: 10px;">messagebus</a> <a href="/tags/morphline/" style="font-size: 10px;">morphline</a> <a href="/tags/quartz/" style="font-size: 10px;">quartz</a> <a href="/tags/rate-limit/" style="font-size: 10px;">rate-limit</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分布式锁/" style="font-size: 10px;">分布式锁</a> <a href="/tags/日志系统/" style="font-size: 17.5px;">日志系统</a> <a href="/tags/消息总线/" style="font-size: 15px;">消息总线</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">十月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">九月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">三月 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">二月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">一月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">十二月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">十一月 2011</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">十月 2011</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">九月 2011</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08/">八月 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">七月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">六月 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">五月 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03/">三月 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">二月 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">七月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">六月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/05/">五月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">四月 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">三月 2010</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02/">二月 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01/">一月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10/">十月 2009</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/10/29/flink-streaming-window-analysis/">Flink流处理之窗口算子分析</a>
          </li>
        
          <li>
            <a href="/2016/09/29/how-flink-optimize-window-with-pane/">Flink如何用窗格来优化窗口</a>
          </li>
        
          <li>
            <a href="/2016/07/23/flink-streaming-job-generate-stream-graph/">Apache Flink Client生成StreamGraph</a>
          </li>
        
          <li>
            <a href="/2016/07/17/flink-streaming-job-submit/">Apache Flink流作业提交流程分析</a>
          </li>
        
          <li>
            <a href="/2016/07/09/flink-type-system-Value-and-interfaces/">Flink类型系统的根Value及基本接口</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Weibo show</h3>
    <div class="widget-weibo">
      <iframe width="100%" height="450" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=2&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1958166695&verifier=9c2d28b9&colors=dddddd,dddddd,666666,0069a4,dddddd&dpc=1"></iframe>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Github</h3>
    <div class="widget-github">
      <script data-name="yanghua" src="http://octocard.in/o.js"></script>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 yanghua1127@gmail.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/projects" class="mobile-nav-link">Projects</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
<script type="text/javascript">
//<![CDATA[
if (typeof jQuery == 'undefined') {
  document.write(unescape("%3Cscript src='/js/jquery-2.0.3.min.js' type='text/javascript'%3E%3C/script%3E"));
}
// ]]>
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?36c1573c11e45ea0f6419af5f2f04760";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
  </div>
</body>
</html>